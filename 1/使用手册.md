
# NL2SQL 使用手册

- 线上环境 Base URL: http://8.134.166.123:8000

本系统实现自然语言到 SQL 的自动转换与执行，内置自愈重试与向量化 Schema 检索能力，适合用于快速构建智能查询 MVP。

## 一、功能概览（MVP）

- 自然语言转 SQL：将中文问题转换为 MySQL 可执行 SQL 并返回结果。
- 自愈重试：SQL 执行失败会基于错误信息自动纠正并重试（默认最多 3 次）。
- 智能 Schema 检索：将数据库表结构向量化（Chroma），按语义相关度检索相关表，提升 SQL 生成准确率。
- 基础管理接口：健康检查、列出表、刷新 Schema 向量库。

不包含（后续可迭代）：
- 鉴权、限流、审计。
- 分页/大结果导出。
- 高级权限控制与脱敏。

## 二、系统架构简述

- 后端框架：`FastAPI`（入口 [main.py](cci:7://file:///Users/zxj/NL2SQL/main.py:0:0-0:0)）
- LLM 接入：OpenAI 兼容接口（推荐阿里云 DashScope 兼容端点）
- 数据库：MySQL（通过环境变量配置）
- 向量数据库：`Chroma` 本地持久化（默认目录 `/app/chroma_db`）
- 核心模块：
  - [text2sql.py](cci:7://file:///Users/zxj/NL2SQL/text2sql.py:0:0-0:0)：SQL 生成与自愈
  - [schema_vectorizer.py](cci:7://file:///Users/zxj/NL2SQL/schema_vectorizer.py:0:0-0:0)：Schema 向量化与语义检索
  - [database.py](cci:7://file:///Users/zxj/NL2SQL/database.py:0:0-0:0)：SQL 执行
  - [create_sample_tables.py](cci:7://file:///Users/zxj/NL2SQL/create_sample_tables.py:0:0-0:0)：示例表与数据初始化

## 三、快速开始（建议演示顺序）

1) 打开 API 文档  
- 访问：http://8.134.166.123:8000/docs

2) 健康检查  
- GET `/health`  
- 预期成功返回：
```json
{ "status": "healthy", "database": "connected" }
```

3) 查看数据库的表  
- GET `/schema/tables`  
- 返回示例：
```json
{ "tables": ["customers","products","orders","executives"] }
```

4) 自然语言查询（核心）  
- POST `/query`  
- 请求示例（中文）：
```bash
curl -X POST "http://8.134.166.123:8000/query" \
  -H "Content-Type: application/json" \
  -d '{
    "question": "显示所有客户信息",
    "max_retries": 3
  }'
```
- 返回字段说明：
  - `success`：是否执行成功
  - `sql_query`：最终执行的 SQL
  - `results`：查询结果行（数组）
  - `columns`：列名（数组）
  - `error`：失败时的错误信息
  - `retry_count`：实际重试次数（0 表示一次成功）

5) 刷新 Schema（变更表结构后）  
- GET `/schema/refresh`  
- 返回：
```json
{ "message": "Schema refreshed successfully" }
```

6) 查看缓存的 Schema（调试用，可选）  
- GET `/schema/info`

## 四、典型问题（可直接复制体验）

- 中文：
  - “显示所有客户信息”
  - “查询大理的客户公司名单”
  - “列出库存数量少于 100 的产品”
  - “查询最近一周的订单总金额”
  - “查询客户风险模块大理矿业公司负责人身份证号”
- 英文：
  - "Show me all customers"
  - "What are the top 3 most expensive products?"

## 五、返回示例

- 成功：
```json
{
  "success": true,
  "sql_query": "SELECT id, company_name, city FROM customers LIMIT 100",
  "results": [
    { "id": 1, "company_name": "大理矿业公司", "city": "大理" }
  ],
  "columns": ["id", "company_name", "city"],
  "error": null,
  "retry_count": 0
}
```

- 失败（自愈后仍失败）：
```json
{
  "success": false,
  "sql_query": "SELECT ...",
  "results": null,
  "columns": null,
  "error": "Error 1054: Unknown column 'xxx' in 'field list'",
  "retry_count": 2
}
```

## 六、使用建议与注意事项

- 自愈机制：初次 SQL 失败会基于错误信息重试，最多 `max_retries` 次，实际次数见 `retry_count`。
- 查询范围：当前未内置分页/限流，建议在自然语言里说明范围（如“前 100 条”）。
- 向量库：
  - 无需单独部署，Chroma 本地持久化于 `/app/chroma_db`。
  - 变更表结构后调用 `/schema/refresh` 重建向量索引。
- 安全：
  - 数据库账号使用“最小权限”原则。
  - 对外接口（如对公网开放）建议加鉴权/限流。
  - 避免在仓库或 Compose 中硬编码敏感密钥，改用环境变量/密钥管理。

## 七、常见问题排查（FAQ）

- `/health` 不健康：
  - 检查数据库可达性与凭证（DB_HOST/DB_PORT/DB_USER/DB_PASSWORD/DB_NAME）。
- 查询一直失败：
  - 用 `/schema/tables` 与 `/schema/info` 确认表是否正确。
  - 如近期变更了表结构，执行 `/schema/refresh`。
- 返回空结果：
  - SQL 正常但确无数据。可放宽条件验证数据是否存在。
- 超时或慢：
  - 缩小范围、添加 LIMIT。
  - 关注 LLM 响应时延（网络/配额）。

## 八、后续演进方向（Roadmap）

- 鉴权/配额/审计与访问日志。
- 分页与大结果导出能力。
- 领域词典与别名、字段注释规范工具化。
- 前端 UI（结果表格、SQL/提示词可视化、失败原因解释）。
- 更细粒度的权限与脱敏支持。
